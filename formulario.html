<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulario de Cotización</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      background: #f4f6f8;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #444;
    }
    label {
      display: block;
      margin: 8px 0 4px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #aaa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
    }
    th, td {
      border: 1px solid #bbb;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #ddd;
    }
    .btn {
      background-color: #4a6fa5;
      border: none;
      color: white;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
    }
    .btn:hover {
      background-color: #3a5980;
    }
    #addConcepto {
      margin-top: 10px;
      background: #5a7db8;
    }
    #addConcepto:hover {
      background: #486797;
    }
    .totales {
      margin-top: 15px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      max-width: 320px;
      float: right;
    }
    .totales div {
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1.1em;
    }
    .clearfix::after {
      content: "";
      display: table;
      clear: both;
    }
  </style>
</head>
<body>

  <h1>Formulario de Cotización</h1>

  <form id="cotizacionForm">

    <label for="fecha">Fecha:</label>
    <input type="date" id="fecha" required />

    <label for="cliente">Cliente:</label>
    <input type="text" id="cliente" placeholder="Nombre del cliente" required />

    <label for="dependencia">Dependencia:</label>
    <input type="text" id="dependencia" placeholder="Dependencia" required />

    <label for="atencion">Con Atención a:</label>
    <input type="text" id="atencion" placeholder="Nombre persona atención" required />

    <table id="conceptosTable">
      <thead>
        <tr>
          <th>Cantidad</th>
          <th>Concepto</th>
          <th>Precio Unitario</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody id="conceptosBody">
        <!-- filas de conceptos -->
      </tbody>
    </table>

    <button type="button" class="btn" id="addConcepto">Agregar Concepto</button>

    <div class="totales clearfix">
      <div>Subtotal: $<span id="subtotal">0.00</span></div>
      <div>IVA (16%): $<span id="iva">0.00</span></div>
      <div>Total: $<span id="total">0.00</span></div>
    </div>

    <div style="clear: both;"></div>

    <button type="submit" class="btn">Guardar Cotización</button>
  </form>

  <script>
    const conceptosBody = document.getElementById('conceptosBody');
    const addConceptoBtn = document.getElementById('addConcepto');

    // Función para crear fila nueva concepto
    function crearFilaConcepto(cantidad = '', concepto = '', precioUnitario = '') {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><input type="number" min="1" value="${cantidad}" class="cantidad" required></td>
        <td><input type="text" value="${concepto}" class="concepto" required></td>
        <td><input type="number" min="0" step="0.01" value="${precioUnitario}" class="precioUnitario" required></td>
        <td><button type="button" class="btn eliminarBtn" style="background:#d9534f;">X</button></td>
      `;

      // Evento para eliminar fila
      tr.querySelector('.eliminarBtn').addEventListener('click', () => {
        tr.remove();
        calcularTotales();
      });

      // Evento para recalcular totales al cambiar valores
      tr.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calcularTotales);
      });

      return tr;
    }

    // Agregar primera fila inicialmente
    conceptosBody.appendChild(crearFilaConcepto());

    addConceptoBtn.addEventListener('click', () => {
      conceptosBody.appendChild(crearFilaConcepto());
    });

    function calcularTotales() {
      let subtotal = 0;
      const filas = conceptosBody.querySelectorAll('tr');
      filas.forEach(tr => {
        const cantidad = parseFloat(tr.querySelector('.cantidad').value) || 0;
        const precioUnitario = parseFloat(tr.querySelector('.precioUnitario').value) || 0;
        subtotal += cantidad * precioUnitario;
      });
      const iva = subtotal * 0.16;
      const total = subtotal + iva;

      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('iva').textContent = iva.toFixed(2);
      document.getElementById('total').textContent = total.toFixed(2);
    }

    // Recalcular totales cada vez que cambien inputs en la tabla
    conceptosBody.addEventListener('input', calcularTotales);

    // Al enviar formulario:
    document.getElementById('cotizacionForm').addEventListener('submit', function(event) {
      event.preventDefault();

      // Recolectar datos
      const fecha = document.getElementById('fecha').value;
      const cliente = document.getElementById('cliente').value.trim();
      const dependencia = document.getElementById('dependencia').value.trim();
      const atencion = document.getElementById('atencion').value.trim();

      // Validar que haya fecha
      if (!fecha) {
        alert("Por favor selecciona la fecha.");
        return;
      }

      // Validar que haya al menos un concepto
      const conceptos = [];
      const filas = conceptosBody.querySelectorAll('tr');
      if (filas.length === 0) {
        alert("Agrega al menos un concepto.");
        return;
      }

      for (const tr of filas) {
        const cantidad = parseFloat(tr.querySelector('.cantidad').value);
        const concepto = tr.querySelector('.concepto').value.trim();
        const precioUnitario = parseFloat(tr.querySelector('.precioUnitario').value);

        if (!cantidad || !concepto || !precioUnitario) {
          alert("Por favor llena todos los campos de conceptos correctamente.");
          return;
        }
        conceptos.push({ cantidad, concepto, precioUnitario });
      }

      const subtotal = parseFloat(document.getElementById('subtotal').textContent);
      const iva = parseFloat(document.getElementById('iva').textContent);
      const total = parseFloat(document.getElementById('total').textContent);

      const data = {
        fecha,
        cliente,
        dependencia,
        atencion,
        conceptos,
        subtotal,
        iva,
        total
      };

      // Enviar datos al Apps Script
      fetch("TU_URL_DE_APPS_SCRIPT_AQUI", {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(response => response.json())
      .then(resp => {
        if (resp.result === "success") {
          alert("Cotización guardada correctamente!");
          this.reset();
          conceptosBody.innerHTML = '';
          conceptosBody.appendChild(crearFilaConcepto());
          calcularTotales();
        } else {
          alert("Error guardando la cotización.");
        }
      })
      .catch(err => {
        alert("Error al conectar con Google Sheets: " + err.message);
      });
    });

    // Calcular totales iniciales
    calcularTotales();
  </script>

</body>
</html>

