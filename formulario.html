<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Cotización</title>
</head>
<body style="font-family: sans-serif; padding: 20px; background-color: #f4f6f8;">

  <h2>Datos del Cliente</h2>
  <label>Cliente: <input type="text" id="cliente" required></label><br>
  <label>Dependencia: <input type="text" id="dependencia" required></label><br>
  <label>Con Atención a: <input type="text" id="atencion" required></label><br><br>

  <h2>Conceptos</h2>
  <div id="conceptos">
    <div class="concepto">
      <input type="text" placeholder="Descripción" class="descripcion" required>
      <input type="number" placeholder="Cantidad" class="cantidad" required>
      <input type="number" placeholder="Precio Unitario" class="precio" required>
    </div>
  </div>
  <button type="button" onclick="agregarConcepto()">Agregar otro concepto</button><br><br>

  <button onclick="guardarDatos()">Generar Cotización</button>

  <script>
    function agregarConcepto() {
      const div = document.createElement('div');
      div.classList.add('concepto');
      div.innerHTML = `
        <input type="text" placeholder="Descripción" class="descripcion" required>
        <input type="number" placeholder="Cantidad" class="cantidad" required>
        <input type="number" placeholder="Precio Unitario" class="precio" required>
      `;
      document.getElementById('conceptos').appendChild(div);
    }

    function guardarDatos() {
      const descripciones = document.querySelectorAll('.descripcion');
      const cantidades = document.querySelectorAll('.cantidad');
      const precios = document.querySelectorAll('.precio');

      const items = [];
      let subtotal = 0;

      for (let i = 0; i < descripciones.length; i++) {
        const descripcion = descripciones[i].value;
        const cantidad = parseFloat(cantidades[i].value);
        const precio = parseFloat(precios[i].value);
        const total = cantidad * precio;
        items.push({ descripcion, cantidad, precio, total });
        subtotal += total;
      }

      const iva = subtotal * 0.16;
      const totalFinal = subtotal + iva;

      const datos = {
        cliente: document.getElementById('cliente').value,
        dependencia: document.getElementById('dependencia').value,
        atencion: document.getElementById('atencion').value,
        items: items,
        subtotal: subtotal,
        iva: iva,
        total: totalFinal
      };

      localStorage.setItem('cotizacion', JSON.stringify(datos));

      fetch("https://script.google.com/macros/s/AKfycbzPzorbbw77_mJ9z32eztHSD1d6Xnm_aSSdLmZncBz1I4aC-LTZMswgprnyS3rfcyU0kQ/exec", {
        method: "POST",
        body: JSON.stringify(datos),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => res.text())
      .then(() => {
        window.location.href = "cotizacion.html";
      })
      .catch(err => alert("Error al enviar a Google Sheets: " + err));
    }
  </script>
</body>
</html>
